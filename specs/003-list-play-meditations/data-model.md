# Data Model: List and Play Meditations

**Bounded Context**: Playback  
**Feature**: US4 - List and Play Generated Meditations  
**Version**: 1.0.0

---

## Domain Entities

### Meditation (Aggregate Root)

**Description**: Represents a meditation generated by the user, with its current processing state and media URLs.

**Attributes**:
- `id` (UUID): Unique identifier
- `userId` (UUID): Owner of the meditation (ensures isolation)
- `title` (String): Meditation title
- `createdAt` (Instant): Creation timestamp
- `processingState` (ProcessingState): Current state of generation process
- `mediaUrls` (MediaUrls): URLs to access generated content

**Business Rules**:
- A meditation can only be played if `processingState == COMPLETED`
- A user can only see their own meditations (`userId` filtering mandatory)
- State must always be one of: PENDING, PROCESSING, COMPLETED, FAILED

**Validation**:
- `id` cannot be null
- `userId` cannot be null
- `title` cannot be empty
- `createdAt` cannot be in the future
- `processingState` cannot be null

---

## Value Objects

### ProcessingState (Enum)

**Description**: Represents the current state of a meditation generation process.

**Values**:
- `PENDING`: "En cola" - Meditation queued for generation
- `PROCESSING`: "Generando" - Currently being generated
- `COMPLETED`: "Completada" - Successfully generated and playable
- `FAILED`: "Fallida" - Generation failed

**Business Rules**:
- Only `COMPLETED` state allows playback
- State transitions are managed by meditation.generation BC (out of scope for playback)
- Labels shown to users: "En cola", "Generando", "Completada", "Fallida"

---

### MediaUrls (Value Object)

**Description**: Contains URLs to access the generated multimedia content.

**Attributes**:
- `audioUrl` (String, optional): URL to audio file (podcast format)
- `videoUrl` (String, optional): URL to video file (video format)
- `subtitlesUrl` (String, optional): URL to subtitles file (if applicable)

**Business Rules**:
- At least one of `audioUrl` or `videoUrl` must be present if state is COMPLETED
- URLs point to S3 storage (managed by meditation.generation BC)
- URLs may be signed or public (depends on US3 implementation)

**Validation**:
- If `processingState == COMPLETED`, at least one URL must be non-null
- URLs must be valid HTTP(S) format

---

## Domain Exceptions

### MeditationNotFoundException

**Trigger**: When attempting to access a meditation with a non-existent ID or not owned by the current user.

**HTTP Mapping**: 404 Not Found

**User Message**: "Meditación no encontrada"

---

### MeditationNotPlayableException

**Trigger**: When attempting to play a meditation with `processingState != COMPLETED`.

**HTTP Mapping**: 409 Conflict

**User Message**: "Esta meditación aún se está procesando. Por favor, espera a que esté lista."

---

## Ports

### In Ports (Use Cases)

#### ListMeditationsUseCase
**Purpose**: Retrieve all meditations for the authenticated user.

**Input**: `userId` (UUID)

**Output**: `List<Meditation>` ordered by `createdAt DESC`

**Business Logic**:
- Filter by `userId` to ensure isolation
- Return all states (PENDING, PROCESSING, COMPLETED, FAILED)
- No pagination in v1 (out of scope)

---

#### GetPlaybackInfoUseCase
**Purpose**: Retrieve playback information for a specific meditation.

**Input**: 
- `meditationId` (UUID)
- `userId` (UUID)

**Output**: `Meditation` with `mediaUrls`

**Business Logic**:
- Validate meditation exists and belongs to `userId`
- Validate `processingState == COMPLETED`
- Throw `MeditationNotFoundException` if not found or not owned
- Throw `MeditationNotPlayableException` if state != COMPLETED

---

### Out Ports (Dependencies)

#### MeditationRepositoryPort
**Purpose**: Access to meditation persistence layer.

**Operations**:
- `findAllByUserId(userId: UUID): List<Meditation>` - Retrieve all meditations for a user
- `findByIdAndUserId(meditationId: UUID, userId: UUID): Optional<Meditation>` - Retrieve specific meditation

**Infrastructure**: Implemented by `PostgreSqlMeditationRepositoryAdapter` using Spring Data JPA

---

## Relationships

### With meditation.generation BC
- **Dependency**: Playback reads data generated by meditation.generation
- **Shared Schema**: `generation` schema in PostgreSQL
- **Shared Table**: `meditations` table
- **Data Flow**: meditation.generation writes → playback reads
- **No Reverse Dependency**: Playback never modifies generation data

---

## Entity-Relationship Diagram

```
┌─────────────────────────────────────┐
│         Meditation                  │
│         (Aggregate Root)            │
├─────────────────────────────────────┤
│ id: UUID (PK)                       │
│ userId: UUID (FK → User)            │
│ title: String                       │
│ createdAt: Instant                  │
│ processingState: ProcessingState    │
│ mediaUrls: MediaUrls (VO)           │
└─────────────────────────────────────┘
            │
            │ contains
            ▼
┌─────────────────────────────────────┐
│         MediaUrls                   │
│         (Value Object)              │
├─────────────────────────────────────┤
│ audioUrl: String?                   │
│ videoUrl: String?                   │
│ subtitlesUrl: String?               │
└─────────────────────────────────────┘

            │
            │ has
            ▼
┌─────────────────────────────────────┐
│      ProcessingState                │
│      (Enum)                         │
├─────────────────────────────────────┤
│ PENDING ("En cola")                 │
│ PROCESSING ("Generando")            │
│ COMPLETED ("Completada")            │
│ FAILED ("Fallida")                  │
└─────────────────────────────────────┘
```

---

## Database Mapping (PostgreSQL)

**Schema**: `generation` (reused from US3)  
**Table**: `meditations`

| Column | Type | Constraint | Domain Attribute |
|--------|------|-----------|------------------|
| id | UUID | PK | Meditation.id |
| user_id | UUID | NOT NULL | Meditation.userId |
| title | VARCHAR(255) | NOT NULL | Meditation.title |
| created_at | TIMESTAMP | NOT NULL | Meditation.createdAt |
| state | ENUM | NOT NULL | Meditation.processingState |
| audio_url | TEXT | NULLABLE | MediaUrls.audioUrl |
| video_url | TEXT | NULLABLE | MediaUrls.videoUrl |
| subtitles_url | TEXT | NULLABLE | MediaUrls.subtitlesUrl |

**Indexes**:
- `idx_meditations_user_id` on `user_id` (for efficient list queries)
- `idx_meditations_created_at` on `created_at DESC` (for ordering)

**Query Patterns**:
- List: `SELECT * FROM generation.meditations WHERE user_id = ? ORDER BY created_at DESC`
- Get by ID: `SELECT * FROM generation.meditations WHERE id = ? AND user_id = ?`

---

## State Transitions (Managed by meditation.generation BC)

**Out of Scope for Playback**: Playback BC is READ-ONLY.

State transitions are managed by meditation.generation BC:
1. User requests generation → `PENDING`
2. Generation starts → `PROCESSING`
3. Generation succeeds → `COMPLETED` (mediaUrls populated)
4. Generation fails → `FAILED`

**Playback Responsibility**: Only read current state and enforce playback rules (COMPLETED only).

---

## Data Flow

```
┌──────────────────────┐
│  meditation.         │
│  generation BC       │  WRITES
│  (US3)               │────────────┐
└──────────────────────┘            │
                                    ▼
                        ┌─────────────────────────┐
                        │ PostgreSQL              │
                        │ Schema: generation      │
                        │ Table: meditations      │
                        └─────────────────────────┘
                                    │
                                    │ READS
                                    ▼
                        ┌──────────────────────┐
                        │  Playback BC         │
                        │  (US4)               │
                        └──────────────────────┘
                                    │
                                    │ displays
                                    ▼
                        ┌──────────────────────┐
                        │  User (Frontend)     │
                        └──────────────────────┘
```

---

## Traceability to BDD

| BDD Scenario | Domain Entity | Attributes Used |
|--------------|---------------|-----------------|
| Scenario 1: List meditations with state | Meditation | id, title, processingState, createdAt |
| Scenario 2: Play completed meditation | Meditation | id, processingState, mediaUrls |

---

**Status**: READY FOR IMPLEMENTATION  
**Dependencies**: PostgreSQL schema `generation` (created in US3)  
**No New Migrations Required**: Reuses existing table structure
