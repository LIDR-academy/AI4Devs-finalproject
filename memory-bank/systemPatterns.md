# System Patterns

## Architecture
The system relies on a **Memory Bank** architecture where state is explicitly documented in Markdown files.

### Monorepo Structure
```text
src/
├── backend/      # FastAPI service (Python 3.11+)
├── frontend/     # React 18 + TypeScript + Vite
├── agent/        # LangGraph agent (future)
└── shared/       # Shared utilities
```

## Core Components
- **Memory Bank**: `/memory-bank/` (State storage)
- **Agent Rules**: `/.agent/rules/` (Behavior enforcement)
- **Backend API**: FastAPI with Pydantic schemas
- **Frontend**: React SPA with TypeScript strict mode
- **Storage**: Supabase Storage for file uploads

## API Contract Patterns

### Frontend-Backend Interface Alignment
**Critical Pattern**: TypeScript interfaces MUST match Pydantic schemas exactly to avoid runtime errors.

#### Upload Flow Contract (T-002-BACK ↔ T-003-FRONT)

**Backend Schema** (`src/backend/schemas.py`):
```python
class UploadRequest(BaseModel):
    filename: str
    size: int
    checksum: Optional[str]

class UploadResponse(BaseModel):
    upload_url: str
    file_id: str      # ← UUID generated by backend
    filename: str     # ← Echo of original filename
```

**Frontend Interface** (`src/frontend/src/types/upload.ts`):
```typescript
interface PresignedUrlRequest {
  filename: string;
  size: number;
  checksum?: string;
}

interface PresignedUrlResponse {
  upload_url: string;
  file_id: string;    // ← Matches backend
  filename: string;   // ← Matches backend
}
```

**Historical Note**: Initial implementation used `file_key` instead of `file_id`, which caused test failures. Fixed in prompt #040 to align with backend reality.

## Backend Architecture Patterns

### Clean Architecture (Implemented in T-004-BACK)
**Pattern**: Separation of Concerns with three-layer architecture.

**Structure**:
```text
src/backend/
├── api/              # API Layer (Controllers)
│   └── upload.py     # Endpoints, request/response handling only
├── services/         # Business Logic Layer
│   └── upload_service.py  # Core business logic
├── constants.py      # Centralized configuration
└── schemas.py        # Pydantic models (DTOs)
```

**Responsibilities**:
- **API Layer** (`api/`): HTTP handling, validation delegation, error mapping
- **Service Layer** (`services/`): Business logic, orchestration, data persistence
- **Constants** (`constants.py`): All magic strings/numbers centralized

**Example** (`T-004-BACK` - Confirm Upload):
```python
# api/upload.py (thin controller)
@router.post("/confirm")
async def confirm_upload(request: ConfirmUploadRequest):
    upload_service = UploadService(supabase_client)
    success, event_id, error = upload_service.confirm_upload(...)
    if not success:
        raise HTTPException(...)
    return ConfirmUploadResponse(event_id=event_id)

# services/upload_service.py (business logic)
class UploadService:
    def confirm_upload(self, file_id, file_key):
        # 1. Verify file in storage
        # 2. Create event record
        # 3. Return result tuple
        ...
```

**Benefits**:
- Testable: Services can be unit tested without HTTP layer
- Reusable: Business logic accessible from CLI/workers/API
- Maintainable: Changes to business rules don't affect routing

### Constants Centralization
**Pattern**: All hardcoded values in `src/backend/constants.py`.

```python
# constants.py
STORAGE_BUCKET_RAW_UPLOADS = "raw-uploads"
EVENT_TYPE_UPLOAD_CONFIRMED = "upload.confirmed"
TABLE_EVENTS = "events"
ALLOWED_EXTENSION = ".3dm"
MAX_FILE_SIZE_MB = 500
```

**Enforcement**: Router and services MUST import from constants, never hardcode strings.

### Testing Patterns
- **Backend**: pytest with integration tests for Supabase Storage
- **Frontend**: Vitest + @testing-library/react
  - **Docker Environment**: node:20-bookworm (Debian) required for jsdom stability
  - **Issue**: Alpine Linux (musl) causes fatal JavaScript memory errors with jsdom
  - **Solution**: Use glibc-based images (Debian/Ubuntu) for frontend testing

## Folder Structure
```text
/memory-bank/   -> Documentation root
/.agent/rules/  -> Rules for AI agents
/src/           -> Source code (monorepo)
/docs/          -> Product documentation
/infra/         -> Infrastructure as code
/tests/         -> Integration tests
```
