# System Patterns

## Architecture
The system relies on a **Memory Bank** architecture where state is explicitly documented in Markdown files.

### Monorepo Structure
```text
src/
├── backend/      # FastAPI service (Python 3.11+)
├── frontend/     # React 18 + TypeScript + Vite
├── agent/        # LangGraph agent (future)
└── shared/       # Shared utilities
```

## Core Components
- **Memory Bank**: `/memory-bank/` (State storage)
- **Agent Rules**: `/.agent/rules/` (Behavior enforcement)
- **Backend API**: FastAPI with Pydantic schemas
- **Frontend**: React SPA with TypeScript strict mode
- **Storage**: Supabase Storage for file uploads

## API Contract Patterns

### Frontend-Backend Interface Alignment
**Critical Pattern**: TypeScript interfaces MUST match Pydantic schemas exactly to avoid runtime errors.

#### Upload Flow Contract (T-002-BACK ↔ T-003-FRONT)

**Backend Schema** (`src/backend/schemas.py`):
```python
class UploadRequest(BaseModel):
    filename: str
    size: int
    checksum: Optional[str]

class UploadResponse(BaseModel):
    upload_url: str
    file_id: str      # ← UUID generated by backend
    filename: str     # ← Echo of original filename
```

**Frontend Interface** (`src/frontend/src/types/upload.ts`):
```typescript
interface PresignedUrlRequest {
  filename: string;
  size: number;
  checksum?: string;
}

interface PresignedUrlResponse {
  upload_url: string;
  file_id: string;    // ← Matches backend
  filename: string;   // ← Matches backend
}
```

**Historical Note**: Initial implementation used `file_key` instead of `file_id`, which caused test failures. Fixed in prompt #040 to align with backend reality.

### Testing Patterns
- **Backend**: pytest with integration tests for Supabase Storage
- **Frontend**: Vitest + @testing-library/react
  - **Docker Environment**: node:20-bookworm (Debian) required for jsdom stability
  - **Issue**: Alpine Linux (musl) causes fatal JavaScript memory errors with jsdom
  - **Solution**: Use glibc-based images (Debian/Ubuntu) for frontend testing

## Folder Structure
```text
/memory-bank/   -> Documentation root
/.agent/rules/  -> Rules for AI agents
/src/           -> Source code (monorepo)
/docs/          -> Product documentation
/infra/         -> Infrastructure as code
/tests/         -> Integration tests
```
