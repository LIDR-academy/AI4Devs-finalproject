openapi: 3.0.3
info:
  title: Meditation Builder - Generation API
  description: |
    API for generating meditation content with professional narration and synchronized subtitles.
    
    Bounded Context: **Generation** (separate from Composition/US2 and Playback/US4)
    
    Core capability:
    - Generate meditation content: Transform composed text + music (+ optional image) 
      into narrated video or audio with synchronized subtitles
    
    Architecture: Hexagonal (Ports & Adapters)
    BDD-First, API-First approach
    
    MVP Infrastructure:
    - TTS: Google Cloud Text-to-Speech (mocked with WireMock in tests)
    - Rendering: FFmpeg (video/audio)
    - Storage: S3 via LocalStack (tests) or AWS S3 (production)
    - Persistence: PostgreSQL (schema: generation, table: meditation)
    
    Authentication: JWT (blocked by US1 - bypass in tests via TestSecurityConfig)
  version: 1.0.0
  contact:
    name: Meditation Builder Team

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server

tags:
  - name: Generation
    description: Meditation content generation with narration

paths:
  /generation/meditations:
    post:
      tags:
        - Generation
      summary: Generate meditation content with narration
      description: |
        Generate professional meditation content with:
        - High-quality narration from text (Google Cloud TTS)
        - Synchronized subtitles (SRT format)
        - Video output (if image provided): narration + music + image + burned subtitles
        - Audio output (if no image): narration + music, subtitles for future use
        
        Processing time validation:
        - Estimates processing time before generation
        - Rejects requests exceeding 30s timeout with 408 error
        
        Idempotency:
        - Same (userId, text, musicRef, imageRef) → same meditationId
        - Uses SHA-256 hash for deduplication
        
        Storage:
        - S3 keys: `generation/{userId}/{meditationId}/(video.mp4|audio.mp3|subs.srt)`
        - Response includes presigned URLs (TTL configurable)
        
        Maps to BDD scenarios:
        - Scenario 1: "Generate narrated video with synchronized subtitles"
        - Scenario 2: "Generate narrated podcast"
        - Scenario 3: "Processing time exceeded"
      operationId: generateMeditationContent
      security:
        - bearerAuth: []
        - {} # Allow no auth in tests (TestSecurityConfig bypass)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateMeditationRequest'
            examples:
              videoRequest:
                summary: Video generation (with image)
                value:
                  text: "Close your eyes and breathe deeply. Feel the air filling your lungs..."
                  musicReference: "calm-ocean-waves"
                  imageReference: "peaceful-landscape-001"
              audioRequest:
                summary: Audio generation (no image)
                value:
                  text: "Welcome to your mindfulness meditation journey. Settle into a comfortable position..."
                  musicReference: "nature-sounds-forest"
      responses:
        '200':
          description: Meditation content generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerationResponse'
              examples:
                videoCompleted:
                  summary: Video generation completed
                  value:
                    meditationId: "550e8400-e29b-41d4-a716-446655440123"
                    type: "VIDEO"
                    mediaUrl: "https://meditation-outputs.s3.amazonaws.com/generation/user-123/550e8400-e29b-41d4-a716-446655440123/video.mp4?X-Amz-Algorithm=..."
                    subtitleUrl: "https://meditation-outputs.s3.amazonaws.com/generation/user-123/550e8400-e29b-41d4-a716-446655440123/subs.srt?X-Amz-Algorithm=..."
                    durationSeconds: 180
                    status: "COMPLETED"
                    message: "Generation completed successfully"
                audioCompleted:
                  summary: Audio generation completed
                  value:
                    meditationId: "550e8400-e29b-41d4-a716-446655440456"
                    type: "AUDIO"
                    mediaUrl: "https://meditation-outputs.s3.amazonaws.com/generation/user-123/550e8400-e29b-41d4-a716-446655440456/audio.mp3?X-Amz-Algorithm=..."
                    subtitleUrl: "https://meditation-outputs.s3.amazonaws.com/generation/user-123/550e8400-e29b-41d4-a716-446655440456/subs.srt?X-Amz-Algorithm=..."
                    durationSeconds: 240
                    status: "COMPLETED"
                    message: "Generation completed successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '408':
          $ref: '#/components/responses/ProcessingTimeout'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalServerError'
  
  /generation/meditations/{meditationId}:
    get:
      tags:
        - Generation
      summary: Get meditation generation status
      description: |
        Poll generation status and retrieve download URLs when complete.
        Used for async generation workflow.
      operationId: getMeditationStatus
      security:
        - bearerAuth: []
        - {} # Allow no auth in tests
      parameters:
        - name: meditationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Meditation ID returned from POST request
      responses:
        '200':
          description: Generation status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerationResponse'
        '404':
          description: Meditation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT authentication (US1 - blocked).
        In tests: security bypassed via TestSecurityConfig (not packaged in production).

  schemas:
    # === Request Schemas ===
    
    GenerateMeditationRequest:
      type: object
      required:
        - text
        - musicReference
      properties:
        text:
          type: string
          description: Meditation text content to narrate
          minLength: 1
          maxLength: 10000
          example: "Close your eyes and breathe deeply. Feel the air filling your lungs..."
        musicReference:
          type: string
          description: Reference to background music from media catalog (BC Composition)
          minLength: 1
          example: "calm-ocean-waves"
        imageReference:
          type: string
          nullable: true
          description: Optional image reference (if present → VIDEO, if absent → AUDIO)
          example: "peaceful-landscape-001"

    # === Response Schemas ===
    
    GenerationResponse:
      type: object
      required:
        - meditationId
        - type
        - status
      properties:
        meditationId:
          type: string
          format: uuid
          description: Unique ID of the generated meditation
          example: "550e8400-e29b-41d4-a716-446655440123"
        type:
          $ref: '#/components/schemas/MediaType'
        mediaUrl:
          type: string
          format: uri
          nullable: true
          description: Presigned S3 URL for video/audio (null if still processing)
          example: "https://meditation-outputs.s3.amazonaws.com/generation/user-123/550e8400-e29b-41d4-a716-446655440123/video.mp4?X-Amz-Algo..."
        subtitleUrl:
          type: string
          format: uri
          nullable: true
          description: Presigned S3 URL for subtitle file (SRT format)
          example: "https://meditation-outputs.s3.amazonaws.com/generation/user-123/550e8400-e29b-41d4-a716-446655440123/subs.srt?X-Amz-Algo..."
        durationSeconds:
          type: integer
          format: int32
          nullable: true
          description: Total duration in seconds (null if still processing)
          example: 180
        status:
          $ref: '#/components/schemas/GenerationStatus'
        message:
          type: string
          nullable: true
          description: Status message or error details
          example: "Generation completed successfully"

    MediaType:
      type: string
      enum:
        - VIDEO
        - AUDIO
      description: |
        Output media type determined by image presence:
        - VIDEO: Image provided (narration + music + image + subtitles)
        - AUDIO: No image (narration + music, subtitles for future use)

    GenerationStatus:
      type: string
      enum:
        - PROCESSING
        - COMPLETED
        - FAILED
        - TIMEOUT
      description: |
        Generation status:
        - PROCESSING: Generation in progress
        - COMPLETED: Successfully generated and stored
        - FAILED: Generation failed (TTS/rendering/storage error)
        - TIMEOUT: Processing time exceeded (>30s)

    ErrorResponse:
      type: object
      required:
        - error
        - message
        - timestamp
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        timestamp:
          type: string
          format: date-time
        details:
          type: object
          nullable: true
          description: Additional error details

  responses:
    BadRequest:
      description: Invalid request parameters or validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            validationError:
              value:
                error: "VALIDATION_ERROR"
                message: "Text content is required and must not exceed 10000 characters"
                timestamp: "2026-02-12T20:00:00Z"
            invalidContent:
              value:
                error: "INVALID_CONTENT"
                message: "Music reference not found in media catalog"
                timestamp: "2026-02-12T20:00:00Z"

    ProcessingTimeout:
      description: Processing time exceeded (text too long)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "GENERATION_TIMEOUT"
            message: "Processing time would exceed 30 seconds. Please send shorter text (estimated: 45s for current content)."
            timestamp: "2026-02-12T20:00:00Z"
            details:
              estimatedSeconds: 45
              maxAllowedSeconds: 30

    ServiceUnavailable:
      description: External service temporarily unavailable (TTS, rendering, storage)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            ttsUnavailable:
              value:
                error: "TTS_SERVICE_UNAVAILABLE"
                message: "Text-to-speech service is temporarily unavailable"
                timestamp: "2026-02-12T20:00:00Z"
            storageUnavailable:
              value:
                error: "STORAGE_SERVICE_UNAVAILABLE"
                message: "Media storage service is temporarily unavailable"
                timestamp: "2026-02-12T20:00:00Z"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "INTERNAL_SERVER_ERROR"
            message: "An unexpected error occurred during generation"
            timestamp: "2026-02-12T20:00:00Z"

# Security applied to all endpoints (bypassed in tests via TestSecurityConfig)
security:
  - bearerAuth: []
