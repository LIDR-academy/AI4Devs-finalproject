name: CI

on:
  push:
    branches: [main, "feature-*"]
  pull_request:
    branches: [main]

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-backend-${{ hashFiles('src/backend/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-buildx-backend-

      - name: Create .env file from secrets
        run: |
          cat > .env << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
          SUPABASE_DATABASE_URL=${{ secrets.SUPABASE_DATABASE_URL }}
          EOF
          echo "✅ .env file created with credentials from GitHub Secrets"

      - name: Build backend Docker image
        run: docker compose build backend
        env:
          DOCKER_BUILDKIT: 1

      - name: Start database service
        run: docker compose up -d db

      - name: Wait for database to be ready
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          timeout 30 bash -c 'until docker compose exec -T db pg_isready -U user; do sleep 1; done'
          echo "✅ PostgreSQL is ready"

      - name: Run backend integration tests
        run: make test
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

      - name: Run backend unit tests (if any)
        run: make test-unit
        continue-on-error: true  # Unit tests folder might be empty

      - name: Show test logs on failure
        if: failure()
        run: |
          echo "=== Backend container logs ==="
          docker compose logs backend
          echo "=== Database container logs ==="
          docker compose logs db

      - name: Cleanup
        if: always()
        run: |
          # Create minimal .env for docker compose down (it reads env_file)
          cat > .env << EOF
          SUPABASE_URL=dummy
          SUPABASE_KEY=dummy
          SUPABASE_DATABASE_URL=dummy
          EOF
          docker compose down -v

  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-frontend-${{ hashFiles('src/frontend/package*.json') }}
          restore-keys: |
            ${{ runner.os }}-buildx-frontend-

      - name: Build frontend Docker image for testing
        run: |
          docker build -t sf-pm-frontend:test \
            --target dev \
            --file src/frontend/Dockerfile \
            src/frontend
        env:
          DOCKER_BUILDKIT: 1

      - name: Run frontend tests
        run: |
          docker run --rm sf-pm-frontend:test npm test

      - name: Show test logs on failure
        if: failure()
        run: |
          echo "=== Frontend tests failed ==="
          docker run --rm sf-pm-frontend:test npm run test -- --reporter=verbose

      - name: Cleanup
        if: always()
        run: |
          # Remove test image
          docker rmi sf-pm-frontend:test || true

  docker-validation:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create minimal .env for validation
        run: |
          cat > .env << EOF
          SUPABASE_URL=dummy
          SUPABASE_KEY=dummy
          SUPABASE_DATABASE_URL=dummy
          EOF

      - name: Validate docker-compose configuration
        run: docker compose config --quiet

      - name: Build production backend image
        run: |
          docker build --target prod \
            -t sf-pm-backend:prod \
            --file src/backend/Dockerfile \
            src/backend
        env:
          DOCKER_BUILDKIT: 1

      - name: Build production frontend image
        run: |
          docker build --target prod \
            -t sf-pm-frontend:prod \
            --file src/frontend/Dockerfile \
            src/frontend
        env:
          DOCKER_BUILDKIT: 1

      - name: Verify image sizes
        run: |
          echo "=== Docker Images ==="
          docker images | grep sf-pm || echo "Images built successfully"
          echo ""
          echo "Backend size:"
          docker images sf-pm-backend:prod --format "{{.Size}}"
          echo "Frontend size:"
          docker images sf-pm-frontend:prod --format "{{.Size}}"
          echo "✅ Production images built successfully"

  lint-and-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff (Python linter)
        run: pip install ruff

      - name: Lint Python code
        run: |
          echo "=== Linting Backend Python Code ==="
          ruff check src/backend/ --select E,F,W --ignore E501
        continue-on-error: true  # Don't fail build on linting issues yet

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: src/frontend
        run: npm ci

      - name: Lint Frontend TypeScript
        working-directory: src/frontend
        run: npm run lint || echo "⚠️ Linting issues found (non-blocking)"
        continue-on-error: true

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true  # Don't fail build yet

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
