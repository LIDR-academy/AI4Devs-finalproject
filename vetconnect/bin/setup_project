#!/usr/bin/env bash
# Script de configuraciÃ³n automÃ¡tica para VetConnect

set -e

echo "ğŸš€ ConfiguraciÃ³n de VetConnect"
echo "================================"
echo ""

# Colores para output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# FunciÃ³n para imprimir mensajes
print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

# Verificar Ruby
echo "ğŸ“¦ Verificando dependencias..."
if ! command -v ruby &> /dev/null; then
    print_error "Ruby no estÃ¡ instalado"
    echo "Por favor, instala Ruby 3.2.0 siguiendo las instrucciones en SETUP.md"
    exit 1
fi
print_success "Ruby $(ruby -v | cut -d' ' -f2) instalado"

# Verificar Bundler
if ! command -v bundle &> /dev/null; then
    print_warning "Bundler no estÃ¡ instalado. Instalando..."
    gem install bundler
fi
print_success "Bundler instalado"

# Verificar PostgreSQL
if ! command -v psql &> /dev/null; then
    print_error "PostgreSQL no estÃ¡ instalado"
    echo "Por favor, instala PostgreSQL siguiendo las instrucciones en SETUP.md"
    exit 1
fi
print_success "PostgreSQL instalado"

echo ""
echo "ğŸ“¥ Instalando gemas de Ruby..."
bundle install

echo ""
echo "ğŸ—„ï¸  Configurando base de datos..."

# Crear archivo .env si no existe
if [ ! -f .env ]; then
    print_warning "Creando archivo .env desde env.example.txt"
    cp env.example.txt .env
    print_success "Archivo .env creado. Por favor, revisa y ajusta las configuraciones."
fi

# Crear base de datos
echo "Creando bases de datos..."
bundle exec rails db:create || print_warning "Las bases de datos ya podrÃ­an existir"

# Ejecutar migraciones
echo "Ejecutando migraciones..."
bundle exec rails db:migrate

# Configurar Active Storage
echo "Configurando Active Storage..."
bundle exec rails active_storage:install || print_warning "Active Storage ya podrÃ­a estar instalado"
bundle exec rails db:migrate

# Preparar base de datos de test
echo "Preparando base de datos de test..."
RAILS_ENV=test bundle exec rails db:create || print_warning "Base de datos de test ya existe"
RAILS_ENV=test bundle exec rails db:migrate

echo ""
read -p "Â¿Deseas cargar datos de ejemplo? (s/n): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[SsYy]$ ]]; then
    echo "ğŸ“Š Cargando datos de ejemplo..."
    bundle exec rails db:seed
    print_success "Datos de ejemplo cargados"
    
    echo ""
    echo "ğŸ“‹ Credenciales de acceso:"
    echo "  Admin:       admin@vetconnect.com / password123"
    echo "  Veterinario: carlos@vetconnect.com / password123"
    echo "  Owner:       maria@example.com / password123"
fi

echo ""
echo "ğŸ§ª Ejecutando tests..."
bundle exec rspec spec/models/pet_spec.rb

echo ""
echo "================================"
print_success "ConfiguraciÃ³n completada!"
echo ""
echo "Para iniciar el servidor, ejecuta:"
echo "  bundle exec rails server"
echo ""
echo "El servidor estarÃ¡ disponible en: http://localhost:3000"
echo ""
