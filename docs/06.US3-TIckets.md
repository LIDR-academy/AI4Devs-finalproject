**US3-01 — Define BDD Feature for Meditation Video Generation**

**Type:** Story

**Layer / Scope:** BDD

**Description:**

Create BDD feature describing business behavior of requesting meditation video generation. Single source of truth for Three Amigos (PO/QA/Backend) and Frontend UX refinement. Champion Guide first step.

**Out of scope:** HTTP, JSON, queues, workers, databases, UI components, status polling (US4), video playback.

**Acceptance Criteria:**

- **`backend/tests/bdd/meditation_builder/video_generation.feature`** exists, syntax-valid Gherkin.
- Pure business language only: "requests generation", "preparation starts", "request rejected", "marked as failed".
- Exact 3 scenarios: valid text→acknowledged; no text→rejected; processing fails→error state.
- PO/QA readable without technical knowledge.
    
    **Attachments / Artifacts:**
    
- **`backend/tests/bdd/meditation_builder/video_generation.feature`**
    
    **AI Execution Hints:**
    
    Use exact business verbs from US3 query. Given/When/Then only. No steps implementation. Validate: **`cucumber --dry-run`**. PO approval before commit.
    

**US3-02 — Define API First Contract for Meditation Creation**

**Type:** Task

**Layer / Scope:** API First

**Description:**

Define OpenAPI contract for POST /meditations to trigger async generation. Authoritative for all implementers.

**Out of scope:** Status polling (US4), video URLs, queue details, domain logic.

**Acceptance Criteria:**

- **`api/openapi/meditation-builder.yaml`** extended:
    - POST /meditations
    - Body: **`{text: string(mandatory), musicRef?: string, imageRef?: string}`**
    - 201 **`{id: UUID, status: "PENDING"}`** | 400 missing text | 422 invalid
    - Authentication: reuse US1 security scheme
    - **`swagger-cli validate`** passes
        
        **Attachments / Artifacts:**
        
- **`api/openapi/meditation-builder.yaml`**
    
    **AI Execution Hints:**
    
    Minimal contract. 202 Accepted pattern. No response polling fields. Extend US1/US2 spec exactly.
    

**US3-03 — Define Meditation Domain Entity + Status Lifecycle**

**Type:** Task

**Layer / Scope:** Domain

**Description:**

TDD pure domain Meditation entity with invariants and status transitions. Framework-free core.

**Out of scope:** JPA/Spring annotations, persistence, HTTP, queues.

**Acceptance Criteria:**

- **`backend/src/main/java/com/meditation/domain/Meditation.java`**: id(UUID), text(mandatory), musicRef?, imageRef?, status(enum), createdAt, updatedAt
- **`backend/src/main/java/com/meditation/domain/MeditationStatus.java`**: PENDING|PROCESSING|DONE|ERROR
- Invariants: text non-empty, reject invalid transitions (DONE→PENDING)
- Methods: **`createPending()`**, **`transitionToError(reason)`**
- **`backend/src/test/java/com/meditation/domain/MeditationTest.java`**: 100% coverage, mutation score >90%
    
    **Attachments / Artifacts:**
    
- Domain entity + enum + unit tests
    
    **AI Execution Hints:**
    
    TDD: red→green→refactor. Immutable where possible. No @Entity/@Spring. AssertJ. Factory methods enforce invariants.
    

**US3-04 — RequestMeditationVideoGeneration Use Case**

**Type:** Task

**Layer / Scope:** Application

**Description:**

Application orchestration: validate→create PENDING→persist→publish job. No business rules.

**Out of scope:** Controller mapping, persistence impl, queue impl.

**Acceptance Criteria:**

- **`backend/src/main/java/com/meditation/application/usecases/RequestMeditationVideoGenerationUseCase.java`**
- Ports: **`MeditationRepository.save()`**, **`MeditationGenerationQueue.publish()`**
- Flow: AuthenticatedUser + input → Meditation(PENDING) → save → publish **`{meditationId, snapshot}`** → return id
- Unit tests: happy path, missing text → DomainException
    
    **Attachments / Artifacts:**
    
- Use case + ports + unit tests
    
    **AI Execution Hints:**
    
    Constructor injection. Define ports in application layer. DTO: **`MeditationGenerationJob`** record.
    

**US3-05 — HandleMeditationProcessingResult Use Case**

**Type:** Task

**Layer / Scope:** Application

**Description:**

Update status from processing result (ERROR/DONE). Future-proof for US4.

**Out of scope:** Worker implementation.

**Acceptance Criteria:**

- **`backend/src/main/java/com/meditation/application/usecases/HandleMeditationProcessingResultUseCase.java`**
- Input: **`{meditationId, success?:boolean, videoUrl?, errorReason?}`**
- Domain transitions + persist. Idempotent.
- Unit tests: ERROR records reason, DONE sets videoUrl, rejects invalid transitions
    
    **Attachments / Artifacts:**
    
- Use case + unit tests
    
    **AI Execution Hints:**
    
    Idempotent: check current status first. No direct infra deps.
    

**US3-06 — Meditation Persistence Adapter**

**Type:** Task

**Layer / Scope:** Infrastructure

**Description:**

JPA repository implementing domain port. Snapshot persistence.

**Out of scope:** Listing/querying (US4).

**Acceptance Criteria:**

- **`backend/src/main/java/com/meditation/infrastructure/persistence/MeditationRepositoryJpa.java`**
- Maps snapshot fields immutable. @CreatedDate/@LastModifiedDate.
- Testcontainers PostgreSQL integration: save→retrieve PENDING by userId
    
    **Attachments / Artifacts:**
    
- JPA entity, repo impl, integration tests
    
    **AI Execution Hints:**
    
    Bidirectional domain↔JPA mapping. Testcontainers postgres:3.4-alpine. H2 for unit tests.
    

**US3-07 — SQS Job Publisher Adapter**

**Type:** Task

**Layer / Scope:** Infrastructure

**Description:**

Idempotent SQS publisher for generation jobs.

**Out of scope:** Worker/consumer.

**Acceptance Criteria:**

- **`backend/src/main/java/com/meditation/infrastructure/queue/SqsMeditationJobPublisher.java`**
- Publishes **`MeditationGenerationJob`** JSON with deduplication (meditationId)
- LocalStack SQS integration test: message verified in queue
    
    **Attachments / Artifacts:**
    
- Publisher + DTO + integration tests
    
    **AI Execution Hints:**
    
    Spring Cloud AWS SQS. FIFO queue. Jackson JSON. LocalStack + Testcontainers.
    

**US3-08 — SQS Worker Skeleton for Job Processing**

**Type:** Task

**Layer / Scope:** Infrastructure

**Description:**

Consumer skeleton: receive job→call use case→update status. Simulate processing.

**Out of scope:** Real video generation (US4).

**Acceptance Criteria:**

- **`backend/src/main/java/com/meditation/infrastructure/worker/MeditationGenerationWorker.java`** @SqsListener
- Idempotent: skip if !PENDING. 20% simulated error rate.
- LocalStack: job→status ERROR/DONE, retries=3, DLQ poison handling
    
    **Attachments / Artifacts:**
    
- Worker + integration tests
    
    **AI Execution Hints:**
    
    VisibilityTimeout=30s, MaxReceives=3. Random error simulation. Separate Spring profile.
    

**US3-09 — MeditationController for Generation Request**

**Type:** Task

**Layer / Scope:** Controller

**Description:**

Wire OpenAPI contract to use case. HTTP→use case mapping only.

**Out of scope:** Domain logic, other endpoints.

**Acceptance Criteria:**

- **`backend/src/main/java/com/meditation/adapter/controller/MeditationController.java`**
- **`@PostMapping("/meditations")`** → **`RequestMeditationVideoGenerationUseCase`** → 201/400
- Contract tests match OpenAPI exactly
    
    **Attachments / Artifacts:**
    
- Controller + contract tests
    
    **AI Execution Hints:**
    
    **`@AuthenticationPrincipal AuthenticatedUser`**. ProblemDetail errors. @Valid request.
    

**US3-10 — Frontend Generate Video Button**

**Type:** Task

**Layer / Scope:** Frontend

**Description:**

Add "Generate Video" action with immediate feedback. US3 UI scope only.

**Out of scope:** Status polling/display (US4).

**Acceptance Criteria:**

- **`frontend/src/pages/MeditationBuilderPage.tsx`**: button disabled if !text
- POST /meditations → toast "Preparation started" (201) | "Complete text first" (400)
- Button loading state during request
    
    **Attachments / Artifacts:**
    
- Updated page + unit tests
    
    **AI Execution Hints:**
    
    React/TypeScript. Axios/fetch + auth header. useState(isLoading). Reuse US2 form state.
    

**US3-11 — Comprehensive US3 Testing Suite**

**Type:** Task

**Layer / Scope:** Testing

**Description:**

Unit + integration + contract tests covering full US3 flow.

**Out of scope:** BDD E2E (US3-12).

**Acceptance Criteria:**

- Domain/app: 90%+ coverage
- Controller: contract tests vs OpenAPI
- Integration: POST→save PENDING→publish→worker→ERROR/DONE (LocalStack+Testcontainers)
    
    **Attachments / Artifacts:**
    
- Tests across all layers
    
    **AI Execution Hints:**
    
    JUnit5 + AssertJ + Testcontainers (Postgres+LocalStack). REST Assured contracts.
    

**US3-12 — BDD E2E Tests for Video Generation Flow**

**Type:** Task

**Layer / Scope:** Testing

**Description:**

Implement US3-01 scenarios against real API + test infrastructure.

**Acceptance Criteria:**

- Cucumber steps for all 3 scenarios green
- Real Spring context + Testcontainers queue/repo
    
    **Attachments / Artifacts:**
    
- **`backend/tests/bdd/meditation_builder/video_generation.steps.js`**
    
    **AI Execution Hints:**
    
    Reuse US1/US2 glue code. No WireMock: real stack.
    

**US3-13 — Integrate US3 into CI/CD Pipeline**

**Type:** Task

**Layer / Scope:** CI/CD

**Description:**

New tests mandatory. Pipeline fail blocks merge.

**Acceptance Criteria:**

- **`.github/workflows/backend.yml`**: unit→int→BDD stages
- Testcontainers/LocalStack profiles. Fast-fail enabled.
    
    **Attachments / Artifacts:**
    
- CI configuration
    
    **AI Execution Hints:**
    
    Extend US2 pipeline. Parallel test stages.
    

**US3-14 — US3 Champion Guide Definition of Done**

**Type:** Story

**Layer / Scope:** Cross-cutting

**Description:**

Validate complete vertical slice, independently deployable.

**Acceptance Criteria:**

- ✅ US3-01 BDD scenarios green
- ✅ US3-02 API contract validated
- ✅ US3-03-10 implementation + tests green
- ✅ US3-11/12 full test suite passing
- ✅ US3-13 CI pipeline green [CI-LINK]
- ✅ Deployed: POST→PENDING→queue→worker→ERROR/DONE observable
    
    **Attachments / Artifacts:**
    
- DoD checklist.md
- CI run URL
    
    **AI Execution Hints:**
    
    Generate checklist automatically. Require human CI link + sign-off. No auto-close.