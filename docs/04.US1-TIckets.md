## AUTH-01 — Define BDD Feature for Secure Access to Meditation Builder

**Type**: Story

**Layer / Scope**: BDD

**Description**

Create the BDD feature that describes secure access to the Meditation Builder using pure business language.

This feature is the single source of truth for functional acceptance and Three Amigos alignment.

**Out of scope**

HTTP, JWT, Cognito, SPA, OAuth, error codes, UI elements.

**Acceptance Criteria**

- A Gherkin feature file exists under **`tests/bdd/authentication/`** and is syntax-valid.
- Language is strictly business/domain oriented.
- No technical nouns (token, login, API, HTTP, session, UI).
- Scenarios included:
    - Successful identification and access to the Meditation Builder.
    - Failed identification with clear user feedback.
    - Expired session requiring re-identification.

**Attachments / Artifacts**

- **`tests/bdd/authentication/access_to_meditation_builder.feature`**

**AI Execution Hints**

- Use only Given / When / Then.
- Use domain verbs: identify, access, continue, retry.
- Do not bind to implementation details.
- Commit only after PO/QA approval (manual checkpoint).

---

## AUTH-02 — Define API First Contract for Authenticated Endpoints

**Type**: Task

**Layer / Scope**: API First

**Description**

Define the minimal OpenAPI contract required to express authentication requirements for meditation endpoints.

This contract is authoritative for backend, frontend, and QA.

**Out of scope**

Meditation business rules, authorization policies beyond authentication.

**Acceptance Criteria**

- OpenAPI file exists at **`api/openapi/meditation-builder.yaml`**.
- Endpoints defined:
    - **`/meditations`** → GET, POST
    - **`/meditations/{id}`** → GET, PUT, DELETE
- Security:
    - **`Authorization: Bearer <token>`** required on all endpoints.
- Responses explicitly defined:
    - **`401`** → unauthenticated (missing token)
    - **`403`** → invalid or expired token
- Example error payloads included.
- OpenAPI validates successfully via CLI.

**Attachments / Artifacts**

- **`api/openapi/meditation-builder.yaml`**

**AI Execution Hints**

- Reuse a single **`securitySchemes`** definition.
- Apply security globally unless explicitly overridden.
- Run **`swagger-cli validate`** and fail on error.

---

## AUTH-03 — Introduce Authenticated User Domain Abstraction (Conditional)

**Type**: Task

**Layer / Scope**: Domain

**Description**

Introduce minimal, framework-free domain abstractions for authenticated identity only if required by domain logic in US1.

⚠️ **This ticket is conditional**:

If no domain rule in US1 requires user identity as a business concept, do not introduce new domain types.

**Out of scope**

JWT, Cognito, OAuth, HTTP, claims, roles, permissions.

**Acceptance Criteria**

- Decision is explicitly documented:
    - ✅ Either **`UserId`** is introduced.
    - ✅ Or ticket is closed as Not Needed for US1.
- If introduced:
    - **`UserId`** is immutable and framework-free.
    - Optional **`AuthenticatedUser`** abstraction contains only business-relevant identity.
    - Zero Spring / AWS / Security dependencies.
    - Domain unit tests validate invariants.

**Attachments / Artifacts**

- **`domain/auth/UserId.java`** (only if needed).
- Domain unit tests.

**AI Execution Hints**

- Default action: do nothing unless explicitly required.
- Prefer **`record`**.
- No annotations, no imports outside **`java.*`**.

---

## AUTH-04 — Define Application Contract for Authenticated Use Cases

**Type**: Task

**Layer / Scope**: Application

**Description**

Define application-level contracts that require an already authenticated user.

Authentication is assumed to be enforced upstream.

**Out of scope**

Token validation, Cognito logic, HTTP concerns.

**Acceptance Criteria**

- All relevant use cases require **`AuthenticatedUser`** (or **`UserId`**) explicitly.
- Missing user results in **`AuthenticationRequiredException`**.
- No security logic inside use cases.
- Unit tests validate fail-fast behavior.

**Attachments / Artifacts**

- Application service interfaces.
- Unit tests.

**AI Execution Hints**

- Package: **`com.meditation.application`**.
- Constructors or method parameters enforce presence.
- Throw immediately on null / missing user.

---

## AUTH-05 — Implement JWT Validation Adapter (AWS Cognito)

**Type**: Task

**Layer / Scope**: Infrastructure

**Description**

Implement a pure infrastructure adapter that validates AWS Cognito JWTs and maps them to an internal authenticated identity representation.

**Out of scope**

Authorization decisions, business rules.

**Acceptance Criteria**

- **`JwtTokenValidator`** validates:
    - Signature via JWKS.
    - Expiration (**`exp`**).
    - Issuer (**`iss`**).
    - Audience (**`aud`**).
- Valid token → infrastructure-level **`AuthenticatedUser`**.
- Token validation failures are represented as a **sealed interface hierarchy**:
    
    `javasealed interface TokenValidationError permits
        ExpiredToken,
        InvalidSignature,
        InvalidClaims {}`
    
    - **`ExpiredToken`** represents expired JWTs.
    - **`InvalidSignature`** represents signature verification failures.
    - **`InvalidClaims`** represents issuer/audience/other claim mismatches.
- JWKS fetched from Cognito and cached with refresh strategy.
- Configuration exclusively via environment variables.

**Attachments / Artifacts**

- **`infrastructure/security/JwtTokenValidator.java`**.
- Configuration properties class.

**AI Execution Hints**

- Package: **`com.meditation.infrastructure.security`**.
- Use **`nimbus-jose-jwt`**.
- Never log token contents.
- One responsibility only: validation + mapping.
- No **`catch (Exception e)`**; always work with **`TokenValidationError`** types.

*(Tu bloque OpenSpec encaja perfecto aquí para dar aún más contexto al agente.)*

---

## AUTH-06 — Implement Stateless Authentication Security Filter

**Type**: Task

**Layer / Scope**: Infrastructure

**Description**

Implement a stateless security filter that enforces JWT-based authentication on protected endpoints.

**Acceptance Criteria**

- Extracts token from **`Authorization`** header: **`Bearer <token>`**.
- Delegates validation to **`JwtTokenValidator`**.
- On success:
    - Builds **`AuthenticatedUser`** and stores it in **`SecurityContext`**.
- On failure, with **explicit mapping error → HTTP**:
    - Missing token → **`401 Unauthorized`**.
    - **`ExpiredToken`** → **`403 Forbidden`**.
    - **`InvalidSignature`** → **`403 Forbidden`**.
    - **`InvalidClaims`** → **`403 Forbidden`**.
- No HTTP session state created (**`SessionCreationPolicy.STATELESS`**).
- Filter order explicitly defined so that it runs before controllers.

**Attachments / Artifacts**

- **`JwtAuthenticationFilter.java`**.
- **`SecurityConfig.java`**.

**AI Execution Hints**

- Extend **`OncePerRequestFilter`**.
- Use **`SessionCreationPolicy.STATELESS`**.
- Protected paths aligned with OpenAPI (AUTH-02).
- Switch on **`TokenValidationError`** sealed hierarchy to decide 401/403.

*(Tu bloque OpenSpec de AUTH‑06 también se puede pegar junto con este ticket.)*

---

## AUTH-07 — Secure Meditation Controllers

**Type**: Task

**Layer / Scope**: Controller

**Description**

Ensure all meditation-related controllers require authenticated access and propagate the authenticated user to application services.

**Acceptance Criteria**

- Controllers cannot be accessed without authentication (security config + filter).
- Controllers pass **`AuthenticatedUser`** (or **`UserId`**) to use cases.
- Controllers contain no auth or business logic.
- Controllers are thin adapters (<50 LOC).
- **`AuthenticatedUser` must be obtained exclusively from `SecurityContext`** (or equivalent annotation), not from headers, params, or manual parsing.

**Attachments / Artifacts**

- **`MeditationController.java`** (and related controllers if any).

**AI Execution Hints**

- Package: **`adapter.controller`**.
- Prefer **`@AuthenticationPrincipal`** (or an equivalent mechanism) to inject **`AuthenticatedUser`**.
- Do not read auth data from request headers manually.
- Do not catch auth-related exceptions in controllers.

---

## AUTH-08a — SPA Login via Cognito Hosted UI (Fixed Strategy)

**Type**: Task

**Layer / Scope**: Frontend

**Description**

Implement explicit user-triggered login via Cognito Hosted UI.

**Acceptance Criteria**

- Login button redirects to Cognito **`/oauth2/authorize`**.
- Flow:
    - Authorization Code.
    - PKCE enabled.
- No client secret in SPA.
- No silent authentication.
- Configuration provided only via environment variables.

**Attachments / Artifacts**

- AuthService login method (or equivalent).

**AI Execution Hints**

- Implement PKCE (code verifier / challenge).
- Do not use backend token exchange in this ticket (that belongs to another story if needed).

---

## AUTH-08b — Handle SPA Auth Callback and Token Storage (Explicit Strategy)

**Type**: Task

**Layer / Scope**: Frontend

**Description**

Handle Cognito OAuth callback entirely in the SPA using PKCE. No backend token exchange in US1.

**Acceptance Criteria**

- **`/auth/callback`** route extracts the **`code`** parameter.
- Token exchange happens directly with Cognito’s **`/oauth2/token`** endpoint.
- Tokens are handled as follows:
    - **`access_token`** → stored in memory only (e.g. store/context).
    - **`id_token`** → stored in memory only.
    - **`refresh_token`** → **not persisted** (out of scope for US1).
- Global auth state is updated.

**Attachments / Artifacts**

- Callback handler implementation.
- Auth state store (e.g. React Context/Redux/Zustand).

**AI Execution Hints**

- No cookies.
- No **`localStorage`** persistence.
- Simplicity > completeness for US1.

---

## AUTH-08c — Protect Meditation Builder Routes in SPA

**Type**: Task

**Layer / Scope**: Frontend

**Description**

Prevent access to Meditation Builder routes when user is not authenticated.

**Acceptance Criteria**

- Route guards (or equivalent) applied to all protected routes:
    - **`/meditation-builder`**.
    - **`/meditations/*`**.
- States handled:
    - **`checking`** → show loading state.
    - **`authenticated`** → allow access.
    - **`unauthenticated`** → redirect to login with **`returnUrl`**.
- Direct URL access to protected routes is handled gracefully (no blank screens, no infinite redirects).

**Attachments / Artifacts**

- Route guard implementation.

**AI Execution Hints**

- Store **`returnUrl`** in query params or state.
- Ensure keyboard focus is managed correctly after redirects.
- Avoid infinite redirect loops.

---

## AUTH-09 — Authentication Test Suite (Deterministic Strategy)

**Type**: Task

**Layer / Scope**: Testing

**Description**

Provide deterministic, automatable test coverage aligned with Champion Guide for authentication behavior across layers.

**Acceptance Criteria**

- Unit tests:
    - **`JwtTokenValidator`** using locally generated test keys or JWKS fixtures.
    - Cover valid token, expired token, invalid signature, invalid claims.
- Integration tests:
    - Protected endpoints with:
        - No token → 401.
        - Invalid/expired token → 403.
        - Valid token → 200 (or endpoint-specific success).
    - Security context mocked or test JWTs injected (no real Cognito).
- BDD tests:
    - Glue code maps AUTH‑01 business steps to API calls.
    - Uses pre-generated valid/expired tokens, not live Cognito.
- All tests run fully offline (no network dependency).

**Attachments / Artifacts**

- Unit tests (e.g. **`JwtTokenValidatorTest.java`**).
- Integration tests (e.g. **`MeditationControllerIT.java`**).
- BDD glue code and test configuration.

**AI Execution Hints**

- No external dependencies.
- Tests must run offline in CI.
- Map each BDD scenario from AUTH‑01 to at least one automated test.

---

## AUTH-10 — Authentication Observability

**Type**: Task

**Layer / Scope**: Infrastructure

**Description**

Add logging, metrics, and traces related to authentication events while avoiding any sensitive data leakage.

**Acceptance Criteria**

- Metrics:
    - **`auth.success`** (authenticated requests).
    - **`auth.unauthenticated`** (401 count).
    - **`auth.invalid_token`** (403 count).
- Logs:
    - Structured JSON logs only.
    - Include correlation/trace ID for each request.
    - No tokens, no claims, no PII.
- If distributed tracing is enabled, include an auth span around validation/filter logic.

**Attachments / Artifacts**

- Logging configuration.
- Metrics registry configuration.

**AI Execution Hints**

- Use Micrometer for metrics (Prometheus compatible).
- Use a JSON logging encoder.
- Mask any potentially sensitive fields if accidentally logged.

---

## AUTH-11 — Enforce Authentication Checks in CI/CD

**Type**: Task

**Layer / Scope**: CI/CD

**Description**

Ensure authentication-related tests are mandatory in the CI/CD pipeline and block merges when broken.

**Acceptance Criteria**

- Pipeline stages (ordered by speed):
    1. Unit tests (including AUTH‑09 unit tests).
    2. Integration tests (AUTH‑09 integration tests).
    3. BDD auth scenarios (AUTH‑09 BDD tests).
- Any failure in these stages must fail the pipeline.
- Merge to **`main`** is blocked if any authentication-related test fails.

**Attachments / Artifacts**

- CI pipeline configuration (GitHub Actions, GitLab CI, Jenkinsfile, etc.).

**AI Execution Hints**

- Enable fast-fail: pipeline stops on first auth failure.
- Parallelize where possible but keep order logical (unit → integration → BDD).

---

## AUTH-12 — Validate US1 Champion Guide Definition of Done

**Type**: Story

**Layer / Scope**: Cross-cutting

**Description**

Validate that User Story 1 meets Champion Guide Definition of Done and is production-ready.

**Acceptance Criteria**

- All of the following are true:
    - ✅ All AUTH‑01 BDD scenarios are automated and passing.
    - ✅ Domain covered by TDD where applicable (AUTH‑03).
    - ✅ The API contract (AUTH‑02) validates and all contract tests pass.
    - ✅ Infrastructure validated via integration tests (AUTH‑09).
    - ✅ No business logic outside the domain layer.
    - ✅ Authentication observability minimal is in place (AUTH‑10).
    - ✅ Authentication checks are enforced in CI/CD (AUTH‑11).
    - ✅ The story is independently deployable and can live in production.
- **Story cannot be closed automatically** without:
    - A linked CI run URL showing all auth-related stages green.
    - Manual sign-off confirming all AUTH tickets are completed and green.

**Attachments / Artifacts**

- DoD checklist (markdown).
- Link to CI run.

**AI Execution Hints**

- Generate the DoD checklist automatically.
- Require a human to paste the CI URL before marking this ticket Done.
- Do not auto-close even if all tests pass.