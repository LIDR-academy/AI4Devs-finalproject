## MB-02-01 — Define BDD Feature for Meditation Content Composition

**Type:** Story

**Layer / Scope:** BDD

**Description**

Create the BDD feature describing the business behavior of composing meditation content.

This feature is the single source of truth for Three Amigos alignment and functional acceptance.

**Out of scope**

HTTP, API, JSON, buttons, uploads, persistence, video generation, technical UI widgets.

**Acceptance Criteria**

- A Gherkin feature file exists at
    
    **`tests/bdd/meditation_builder/content_composition.feature`** and is syntax-valid.
    
- Language is strictly business/domain oriented (no technical nouns).
- Scenarios cover:
    - User is invited to write the meditation text (mandatory).
    - User asks the system to create meditation text when none exists.
    - User asks the system to refine or extend meditation text using existing content as context.
    - User listens to a preview of selected or generated music.
    - User sees a preview of a selected or generated image.

**Attachments / Artifacts**

- `tests/bdd/meditation_builder/content_composition.feature`

**AI Execution Hints**

- Use only **Given / When / Then**.
- Use business verbs: *is invited to write*, *asks the system to create*, *listens to*, *sees a preview*.
- Do not reference UI controls, clicks, fields, APIs, or files.
- Commit only after PO/QA approval (manual checkpoint).

---

## MB-02-02 — Define API First Contract for AI Content Generation & Preview

**Type:** Task

**Layer / Scope:** API First

**Description**

Define the minimal OpenAPI contract for user-triggered AI content generation and previews required by US2.

This contract is authoritative for backend, frontend, and QA.

**Out of scope**

Persistence, video generation, authorization rules beyond authentication.

**Acceptance Criteria**

- OpenAPI file updated at **`api/openapi/meditation-builder.yaml`**.
- Endpoints defined:
    - `POST /meditation-builder/ai/text`
    - `POST /meditation-builder/ai/music`
    - `POST /meditation-builder/ai/image`
    - `GET /meditation-builder/preview/music/{id}`
    - `GET /meditation-builder/preview/image/{id}`
- All endpoints:
    - Require authentication (reuse US1 security scheme).
    - Are explicitly documented as **user-triggered only**.
    - Do **not** create or persist meditation entities.
- Responses defined:
    - `200` success
    - `400` invalid input
    - `429` AI rate-limited
    - `503` AI unavailable / timeout
- Example request and response payloads included.
- OpenAPI validates via CLI.

**Attachments / Artifacts**

- `api/openapi/meditation-builder.yaml`

**AI Execution Hints**

- Extend existing OpenAPI from US1.
- Reuse a single `securitySchemes` definition.
- Apply security globally.
- Run `swagger-cli validate` and fail on error.

---

## MB-02-03 — Domain Validation Rules for Meditation Content (Conditional)

**Type:** Task

**Layer / Scope:** Domain

**Description**

Introduce domain-level validation only if US2 requires business-critical, consistent rules (e.g. text length bounds, allowed media types).

⚠️ Conditional ticket.

**Out of scope**

HTTP, persistence, AI integration.

**Acceptance Criteria**

- Decision explicitly documented:
    - ✅ Option A: introduce domain validation
    - ✅ Option B: close ticket as **“Not Needed for US2”**
- If Option A:
    - Immutable, framework-free domain object (e.g. `MeditationContent`).
    - Validates business rules (e.g. text length).
    - Zero Spring / infrastructure dependencies.
    - Unit tests written with TDD.

**Attachments / Artifacts**

- `domain/MeditationContent.java` (only if needed)
- Domain unit tests

**AI Execution Hints**

- Default action: close as *Not Needed*.
- Create domain types only if rules must be enforced outside UI.
- Use `record` where appropriate.

---

## MB-02-04 — Application Services for AI Content Orchestration

**Type:** Task

**Layer / Scope:** Application

**Description**

Define application-level use cases that orchestrate AI content generation calls.

No business rules or persistence logic.

**Out of scope**

HTTP, persistence, domain validation.

**Acceptance Criteria**

- Use cases defined:
    - `GenerateMeditationTextUseCase`
    - `GenerateMeditationMusicUseCase`
    - `GenerateMeditationImageUseCase`
- Each use case:
    - Requires `AuthenticatedUser` from US1.
    - Delegates to infrastructure ports.
    - Fails fast if user is missing.
- Unit tests cover orchestration paths.

**Attachments / Artifacts**

- `application/usecases/GenerateMeditation*UseCase.java`
- Unit tests

**AI Execution Hints**

- Package: `com.meditation.application.usecases`
- Stateless services, no framework annotations if possible.

---

## MB-02-05a — Infrastructure Adapter: Text Generation AI Client

**Type:** Task

**Layer / Scope:** Infrastructure

**Description**

HTTP adapter calling an external AI service to generate meditation text.

**Acceptance Criteria**

- Implements `TextGenerationPort`.
- Timeout: 30s.
- Retries: 3 attempts.
- Input: optional existing text → Output: generated text.
- Errors mapped to shared taxonomy:
    - `AiTimeout`
    - `AiUnavailable`
    - `AiRateLimited`

**Attachments / Artifacts**

- `infrastructure/ai/TextGenerationAiAdapter.java`

**AI Execution Hints**

- Use `WebClient` or `RestClient`.
- Config via environment variables.
- No logging of prompts or AI responses.

---

## MB-02-05b — Infrastructure Adapter: Music Generation AI Client

**Type:** Task

**Layer / Scope:** Infrastructure

**Description**

HTTP adapter calling an external AI service to generate music previews.

**Acceptance Criteria**

- Implements `MusicGenerationPort`.
- Timeout: 60s.
- Retries: 2 attempts.
- Returns preview identifier or URL.
- Uses shared `AiError` taxonomy.

**Attachments / Artifacts**

- `infrastructure/ai/MusicGenerationAiAdapter.java`

**AI Execution Hints**

- Longer timeout due to audio generation.
- No persistence of audio assets.

---

## MB-02-05c — Infrastructure Adapter: Image Generation AI Client

**Type:** Task

**Layer / Scope:** Infrastructure

**Description**

HTTP adapter calling an external AI service to generate images.

**Acceptance Criteria**

- Implements `ImageGenerationPort`.
- Timeout: 45s.
- Retries: 3 attempts.
- Returns preview identifier or URL.
- Uses shared `AiError` taxonomy.

**Attachments / Artifacts**

- `infrastructure/ai/ImageGenerationAiAdapter.java`

**AI Execution Hints**

- Return URLs, not inline binary data.

---

## MB-02-06 — Meditation Builder Content Controllers

**Type:** Task

**Layer / Scope:** Controller

**Description**

Expose HTTP endpoints that materialize the API-First contract for US2.

**Acceptance Criteria**

- Controllers map:
    - `POST /meditation-builder/ai/text`
    - `POST /meditation-builder/ai/music`
    - `POST /meditation-builder/ai/image`
    - Preview endpoints for music and image
- All endpoints:
    - Require authentication.
    - Delegate to application layer only.
    - Map `AiError` → HTTP codes (400 / 429 / 503).
- Controllers are thin (<30 LOC per method).

**Attachments / Artifacts**

- `MeditationBuilderController.java`

**AI Execution Hints**

- Use `@AuthenticationPrincipal`.
- Match OpenAPI exactly.

---

## MB-02-07a — Frontend: Meditation Builder Layout & Text Composition

**Type:** Story

**Layer / Scope:** Frontend

**Description**

Implement the Meditation Builder UI with mandatory text composition and AI assistance.

**Acceptance Criteria**

- Layout includes:
    - Mandatory meditation text section.
    - Optional music section.
    - Optional image section.
- Text composition:
    - Required validation.
    - “Generate with AI” action.
    - Empty text → generate from scratch.
    - Existing text → generate using it as context.
- States handled: idle, loading, success, error (non-blocking).

**Attachments / Artifacts**

- `MeditationBuilderPage.tsx`

**AI Execution Hints**

- React + TypeScript.
- Disable AI trigger while loading.

---

## MB-02-07b — Frontend: Music & Image Sections with Preview

**Type:** Task

**Layer / Scope:** Frontend

**Description**

Implement optional music and image composition with previews.

**Acceptance Criteria**

- Music:
    - Upload or AI generation.
    - Audio preview playback.
- Image:
    - Upload or AI generation.
    - Image preview display.
- Each section supports loading, success, error states.
- No validation (optional content).

**Attachments / Artifacts**

- `MusicSection.tsx`
- `ImageSection.tsx`

**AI Execution Hints**

- Use native `<audio>` and `<img>` elements.
- Skeleton loaders during generation.

---

## MB-02-08 — Frontend HTTP Client Integration

**Type:** Task

**Layer / Scope:** Frontend

**Description**

Connect frontend actions to backend AI and preview endpoints.

**Acceptance Criteria**

- HTTP client:
    - Automatically adds `Authorization` header (reuse US1 interceptor).
- AI actions call `/ai/*` endpoints explicitly.
- Error handling:
    - `401/403` → auth recovery.
    - `429/503` → user-friendly retry message.
- Preview endpoints accessed with authentication.

**Attachments / Artifacts**

- `apiClient.ts`

**AI Execution Hints**

- Centralize error mapping.
- Prevent double submissions.

---

## MB-02-09 — Content Composition Test Suite

**Type:** Task

**Layer / Scope:** Testing

**Description**

Provide deterministic, offline test coverage for US2.

**Acceptance Criteria**

- Backend unit tests:
    - AI adapters (success, timeout, rate limit).
- Backend integration tests:
    - Controllers with mocked AI providers.
- Frontend unit tests:
    - State transitions (loading/error/success).
- BDD/E2E:
    - MB-02-01 scenarios executed end-to-end with mocks.

**Attachments / Artifacts**

- Backend and frontend tests
- BDD glue code

**AI Execution Hints**

- No external AI dependencies.
- Fully offline in CI.

---

## MB-02-10 — Wire US2 Tests into CI/CD Pipeline

**Type:** Task

**Layer / Scope:** CI/CD

**Description**

Ensure all US2 tests are mandatory before merge.

**Acceptance Criteria**

- Pipeline stages include:
    - Backend unit + integration tests.
    - Frontend build and tests.
    - BDD scenarios.
- Any failure blocks merge to main.

**Attachments / Artifacts**

- CI configuration update

**AI Execution Hints**

- Extend US1 pipeline.
- Enable fast-fail.

---

## MB-02-11 — Validate US2 Champion Guide Definition of Done

**Type:** Story

**Layer / Scope:** Cross-cutting

**Description**

Validate that User Story 2 meets Champion Guide criteria and is production-ready.

**Acceptance Criteria**

- ✅ All MB-02-01 BDD scenarios automated and passing.
- ✅ API contract validated (MB-02-02).
- ✅ Domain rules addressed or explicitly skipped (MB-02-03).
- ✅ Tests passing (MB-02-09).
- ✅ CI/CD enforced (MB-02-10).
- ✅ Independently deployable.

**Attachments / Artifacts**

- DoD checklist (markdown).
- Link to successful CI run.

**AI Execution Hints**

- Generate checklist automatically.
- Require human sign-off before closing.