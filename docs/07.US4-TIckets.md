### **US4-01 — Define BDD Feature for List and Play Meditations**

**Type:** Story

**Layer / Scope:** BDD

**Description:**

Create BDD feature describing business behavior for listing a user’s meditations and conditionally allowing playback. This is the single source of truth for Three Amigos (PO/QA/Backend) and Frontend UX refinement, and the first step of the Champion Guide.

This feature intentionally describes *what the user perceives*, not how the system is implemented.

**Out of scope:**

HTTP endpoints, JSON structures, pagination mechanics, UI components, video player implementation details, signed URLs, background processing.

**Acceptance Criteria:**

- `backend/tests/bdd/meditation_builder/list_and_play.feature` exists and is valid Gherkin.
- Scenarios use pure business language only (no HTTP, no API, no “endpoint”, no “video tag”).
- Exactly 3 scenarios:
    - User lists their meditations and sees current status for each.
    - User plays a meditation that is completed.
    - User cannot play a meditation that is not completed (only status is shown).
- Readable and reviewable by PO/QA without technical context.

**Attachments / Artifacts:**

- `backend/tests/bdd/meditation_builder/list_and_play.feature`

**AI Execution Hints:**

- Translate US4 business rules verbatim into Gherkin.
- Use Given / When / Then only.
- Do not create step definitions yet.
- Validate with `cucumber --dry-run`.
- Stop after feature creation; PO approval required before implementation.

---

### **US4-02 — Define API First Contract for Meditation Listing**

**Type:** Task

**Layer / Scope:** API First

**Description:**

Extend the OpenAPI contract with a pageless endpoint for listing the authenticated user’s meditations.

This endpoint is intentionally simple (no pagination yet) to support MVP usage; pagination will be introduced in a later story.

**Out of scope:**

Pagination parameters, filtering, mutations, queue interactions, signed URL generation.

**Acceptance Criteria:**

- `api/openapi/meditation-builder.yaml` includes:
    - `GET /meditations`
- Response `200 OK` body:
    
    ```yaml
    -id:UUID
    status:enum(PENDING,PROCESSING,DONE,ERROR)
    videoUrl?:string
    createdAt:date-time
    textPreview?:string
    
    ```
    
- `videoUrl` is **present only when status = DONE**.
- Results sorted by `createdAt DESC`.
- Maximum 50 items returned.
- Authentication required (reuse US1 JWT security scheme).
- `swagger-cli validate` passes.

**Attachments / Artifacts:**

- `api/openapi/meditation-builder.yaml`

**AI Execution Hints:**

- Extend existing US3 schema; do not redefine security schemes.
- No query parameters.
- Empty list returns `200 []`, not `404`.
- Keep schema minimal; avoid “future” fields.

---

### **US4-03 — Extend Meditation Domain for Safe Video Access**

**Type:** Task

**Layer / Scope:** Domain

**Description:**

Extend the Meditation domain entity to safely expose video access only when the meditation is completed.

This protects invariants and prevents leaking video references for non-completed meditations.

**Out of scope:**

Persistence annotations, JSON serialization, signed URLs, HTTP concerns.

**Acceptance Criteria:**

- `backend/src/main/java/com/meditation/domain/Meditation.java` includes:
    - `getSafeVideoReference()` (or equivalent) returning the video reference **only if status = DONE**, otherwise `null`.
- Invariant enforced: non-DONE meditations never expose video reference.
- Existing status transition rules from US3 remain enforced.
- Unit tests cover:
    - DONE exposes reference.
    - PENDING/PROCESSING/ERROR return `null`.

**Attachments / Artifacts:**

- `backend/src/main/java/com/meditation/domain/Meditation.java`
- Updated `backend/src/test/java/com/meditation/domain/MeditationTest.java`

**AI Execution Hints:**

- TDD first.
- Treat `videoReference` as a storage key or identifier, **not a signed URL**.
- Pure domain logic only; no framework annotations.

---

### **US4-04 — ListUserMeditationsUseCase**

**Type:** Task

**Layer / Scope:** Application

**Description:**

Application-level orchestration for listing a user’s meditations in a pageless, sorted view.

Maps domain entities into lightweight list items suitable for API exposure.

**Out of scope:**

Repository implementation, HTTP mapping, frontend concerns.

**Acceptance Criteria:**

- `backend/src/main/java/com/meditation/application/usecases/ListUserMeditationsUseCase.java` exists.
- Input: `AuthenticatedUser`.
- Flow:
    - Load meditations by user.
    - Sort by `createdAt DESC`.
    - Limit to 50.
    - Map to `MeditationListItem` DTO:
        - `id`, `status`, `safeVideoReference`, `createdAt`, `textPreview` (first 100 chars).
- Unit tests cover:
    - Empty list.
    - Mixed statuses.
    - DONE vs non-DONE video reference exposure.

**Attachments / Artifacts:**

- Use case class
- `MeditationListItem.java`
- Unit tests

**AI Execution Hints:**

- Use repository port only.
- Enforce limit in application layer, not just DB.
- Use Java `record` for DTO.

---

### **US4-05 — Extend MeditationRepository Port and Implementation**

**Type:** Task

**Layer / Scope:** Infrastructure

**Description:**

Provide repository support for loading a user’s meditations in reverse chronological order, capped at 50 items.

**Out of scope:**

Pagination, filtering, signed URLs.

**Acceptance Criteria:**

- Port:
    - `List<Meditation> findByUserIdSorted(UserId userId)`
- JPA implementation:
    - Sorted by `createdAt DESC`.
    - Hard limit of 50.
- Integration test:
    - Persist 60 meditations.
    - Query returns newest 50 only.

**Attachments / Artifacts:**

- Repository port
- JPA implementation
- `MeditationRepositoryIntegrationTest.java`

**AI Execution Hints:**

- JPQL or native query acceptable.
- Use Testcontainers PostgreSQL.
- Keep domain ↔ JPA mapping explicit.

---

### **US4-06 — S3 Signed Playback URL Generator Adapter**

**Type:** Task

**Layer / Scope:** Infrastructure

**Description:**

Infrastructure adapter responsible for generating short-lived signed playback URLs for meditation videos.

This adapter is invoked by the application layer **only for DONE meditations** when preparing list responses.

**Out of scope:**

Public URLs, list generation logic, access control rules.

**Acceptance Criteria:**

- `backend/src/main/java/com/meditation/infrastructure/storage/S3VideoUrlGenerator.java` exists.
- Method generates pre-signed GET URL with 5-minute expiry.
- Integration test using LocalStack verifies URL validity.

**Attachments / Artifacts:**

- Adapter class
- Integration test

**AI Execution Hints:**

- Spring Cloud AWS S3 client.
- Use presigner API.
- Do not cache URLs.

---

### **US4-07 — MeditationController GET /meditations**

**Type:** Task

**Layer / Scope:** Controller

**Description:**

Expose the meditation list endpoint, mapping HTTP requests to the application use case.

**Out of scope:**

Business logic, mutations, pagination.

**Acceptance Criteria:**

- `@GetMapping("/meditations")` implemented.
- Uses `@AuthenticationPrincipal`.
- Delegates to `ListUserMeditationsUseCase`.
- Response matches OpenAPI contract exactly.
- Contract tests pass.

**Attachments / Artifacts:**

- Controller method
- Contract tests

**AI Execution Hints:**

- No `@Pageable`.
- Return empty list as `200 OK`.

---

### **US4-08 — MeditationListPage Component**

**Type:** Task

**Layer / Scope:** Frontend

**Description:**

Implement pageless meditation list UI consuming the listing endpoint and displaying statuses.

**Out of scope:**

Video playback logic, infinite scroll.

**Acceptance Criteria:**

- `MeditationListPage.tsx` fetches list on mount.
- Loading, empty, and error states handled.
- Items sorted newest first.
- Status badges:
    - PENDING (yellow)
    - PROCESSING (blue)
    - DONE (green)
    - ERROR (red)

**Attachments / Artifacts:**

- Page component
- API hook

**AI Execution Hints:**

- React + TypeScript.
- TanStack Query or SWR allowed.
- Reuse US1 auth-aware HTTP client.

---

### **US4-09 — MeditationCard with Conditional Play**

**Type:** Task

**Layer / Scope:** Frontend

**Description:**

Card component showing meditation status and enabling playback only for completed meditations.

**Out of scope:**

List container, advanced player features.

**Acceptance Criteria:**

- DONE meditations show `<video>` with controls.
- Non-DONE show status only.
- No video element rendered unless DONE.

**Attachments / Artifacts:**

- `MeditationCard.tsx`

**AI Execution Hints:**

- Native HTML5 `<video>`.
- `videoUrl?: string` prop.

---

### **US4-10 — Frontend Navigation to Meditation List**

**Type:** Task

**Layer / Scope:** Frontend

**Description:**

Add navigation entry to access the meditation list.

**Out of scope:**

List implementation details.

**Acceptance Criteria:**

- “My Meditations” link navigates to `/meditations`.
- Route protected by existing auth guard.

**Attachments / Artifacts:**

- Routing updates

**AI Execution Hints:**

- React Router v6.
- Reuse US1 auth logic.

---

### **US4-11 — Backend Unit and Integration Tests**

**Type:** Task

**Layer / Scope:** Testing

**Description:**

Comprehensive backend test coverage for US4.

**Out of scope:**

Frontend tests, BDD E2E.

**Acceptance Criteria:**

- Domain tests for safe video access.
- Application tests for mixed statuses.
- Integration test:
    - GET `/meditations`
    - DONE items include signed URLs.
- ≥90% coverage.

**Attachments / Artifacts:**

- Test classes

**AI Execution Hints:**

- Testcontainers: PostgreSQL + S3 LocalStack.
- Seed deterministic data.

---

### **US4-12 — BDD E2E Tests for List and Play**

**Type:** Task

**Layer / Scope:** Testing

**Description:**

Implement end-to-end execution of US4 BDD scenarios against the real backend stack.

**Acceptance Criteria:**

- All US4-01 scenarios green.
- DONE meditation playback verified.

**Attachments / Artifacts:**

- Step definitions

**AI Execution Hints:**

- Cucumber + Spring context.
- Use Testcontainers; no WireMock.

---

### **US4-13 — Extend CI/CD Pipeline for US4**

**Type:** Task

**Layer / Scope:** CI/CD

**Description:**

Ensure US4 tests are mandatory and executed in CI.

**Acceptance Criteria:**

- Pipeline stages include backend unit → integration → BDD → frontend.
- LocalStack S3 + PostgreSQL enabled.
- Failures block merge.

**Attachments / Artifacts:**

- Workflow updates

**AI Execution Hints:**

- Extend US3 pipeline.
- Parallelize where possible.

---

### **US4-14 — US4 Champion Guide Definition of Done**

**Type:** Story

**Layer / Scope:** Cross-cutting

**Description:**

Validate that US4 delivers an independently deployable vertical slice.

**Acceptance Criteria:**

- ✅ US4-01 BDD scenarios green
- ✅ US4-02 API contract validated
- ✅ US4-03–07 backend implementation green
- ✅ US4-08–10 frontend deployed
- ✅ US4-11/12 tests passing
- ✅ US4-13 CI green
- ✅ Deployed: user can list meditations and play DONE ones only

**Attachments / Artifacts:**

- `DoD-checklist.md`
- CI run URL

**AI Execution Hints:**

- Auto-generate checklist.
- Human provides CI link and sign-off.