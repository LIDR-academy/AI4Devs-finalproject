## US1 — Autenticación y acceso seguro

**Título**

Acceder de forma segura al Meditation Builder

**User Story**

Como usuario, quiero identificarme de forma segura en el sistema para poder acceder al Meditation Builder y gestionar mis meditaciones.

**Descripción (negocio)**

Los usuarios deben identificarse antes de poder acceder al Meditation Builder y a cualquier funcionalidad relacionada con meditaciones. Una vez identificado, el usuario puede navegar por el sistema sin volver a introducir sus credenciales mientras su sesión siga siendo válida.

**Criterios de aceptación (BDD, lenguaje de negocio)**

`textFeature: Acceso seguro al Meditation Builder

  Scenario: Usuario se identifica correctamente
    Given existe un usuario registrado en el sistema de meditación
    When se identifica correctamente en la aplicación
    Then puede acceder al Meditation Builder
    And puede usar las funciones de creación y gestión de meditaciones

  Scenario: Credenciales incorrectas impiden el acceso
    Given existe un usuario registrado en el sistema de meditación
    When introduce credenciales incorrectas al intentar identificarse
    Then el acceso al sistema es rechazado
    And el usuario es informado de que sus credenciales no son válidas

  Scenario: Sesión expirada impide el acceso
    Given el usuario se había identificado anteriormente
    And su sesión ya no es válida
    When intenta acceder al Meditation Builder
    Then el acceso es rechazado
    And el usuario es informado de que debe identificarse de nuevo`

**Notas técnicas (no en Gherkin, para diseño/API)**

- La identificación se implementa con AWS Cognito y tokens JWT sin estado en el servidor.
- El token se valida en cada petición a endpoints protegidos.
- Las respuestas técnicas corresponden a 401 cuando las credenciales son inválidas y 403 cuando el token es inválido o está expirado.

---

## US2 — Componer contenido de meditación

**Título**

Componer contenido de meditación con ayuda opcional de IA

**User Story**

Como usuario autenticado, quiero definir el texto, la música y la imagen de una meditación, pudiendo escribirlos manualmente o generarlos con ayuda de IA, para personalizar el contenido antes de crear el vídeo final.

**Descripción (negocio)**

El Meditation Builder permite al usuario definir el contenido de una meditación a través de un campo de texto obligatorio y opciones de música e imagen opcionales. El usuario puede escribir o subir contenido, o pedir al sistema que lo genere a partir de su entrada actual. El usuario puede previsualizar la música y la imagen antes de continuar, sin que todavía se guarde nada de forma permanente.

**Criterios de aceptación (BDD, lenguaje de negocio)**

`Feature: Composición de contenido de meditación

  Scenario: Visualización del campo de texto obligatorio
    Given el usuario está autenticado
    When accede al Meditation Builder
    Then ve un campo de texto obligatorio para definir el contenido de la meditación

  Scenario: Generar texto de meditación desde cero
    Given el usuario está autenticado
    And el campo de texto de la meditación está vacío
    When solicita que el sistema genere el texto de la meditación
    Then el sistema propone un texto completo de meditación en el campo de texto

  Scenario: Generar texto de meditación a partir de contenido existente
    Given el usuario está autenticado
    And el campo de texto de la meditación contiene contenido
    When solicita que el sistema genere el texto de la meditación
    Then el sistema propone un nuevo texto de meditación teniendo en cuenta el contenido existente

  Scenario: Previsualizar música de la meditación
    Given el usuario ha seleccionado música para la meditación
    When solicita previsualizar la música
    Then el sistema reproduce una previsualización de la música seleccionada

  Scenario: Previsualizar imagen de la meditación
    Given el usuario ha seleccionado una imagen para la meditación
    When solicita previsualizar la imagen
    Then el sistema muestra una previsualización de la imagen seleccionada`

**Notas técnicas**

- Las acciones de generación de texto, música e imagen se activan siempre de forma explícita por el usuario (no hay llamadas automáticas a IA).
- La música y la imagen son opcionales pero siempre previsualizables si existen.
- No se realiza persistencia de la meditación en esta historia; el estado vive en la sesión/UI.

---

# US3 — Generar meditación guiada (vídeo/podcast) con Google TTS + FFmpeg

## Título
Generar vídeo/podcast con voz real Google TTS + subtítulos sincronizados

## User Story
**Como usuario autenticado**, quiero generar contenido de meditación enviando **texto plano** y música (imagen opcional), **para que el sistema genere voz real con Google TTS, subtítulos sincronizados y produzca vídeo MP4 o podcast MP3 profesional**.

## Descripción (negocio)
El sistema **SIEMPRE** usa Google TTS para voz real + FFmpeg para:

- **Vídeo**: Imagen fija + **Google TTS voz + música fondo + subtítulos sincronizados** → MP4
- **Podcast**: **Google TTS voz + música fondo normalizada** → MP3

**~20s respuesta**, archivos en S3, Postgres asociado al usuario y estado de procesamiento. Si Google TTS o FFmpeg exceden 30s → error 408.

## Criterios de aceptación (BDD)

```gherkin
Feature: Generación profesional con Google TTS + FFmpeg (voz real siempre)

  Scenario: Generar vídeo con Google TTS + subtítulos sincronizados
    Given el usuario está autenticado
    And envía texto plano de meditación:
      """
      Respira profundamente. Siente el aire entrar por tu nariz. Relájate completamente. Suelta toda tensión.
      """
    And ha seleccionado una pista de audio válida
    And ha seleccionado una imagen válida
    When solicita generar el contenido
    Then el sistema genera voz real con Google TTS desde el texto
    And transforma texto plano en SRT sincronizado automáticamente:
      """
      1
      00:00:01,000 --> 00:00:05,000
      Respira profundamente
      
      2
      00:00:06,000 --> 00:00:10,000
      Siente el aire entrar por tu nariz
      """
    And FFmpeg mezcla Google TTS voz (principal) + música fondo (-12dB)
    And FFmpeg renderiza imagen fija + voz real + texto animado sincronizado
    And la meditación se guarda tipo "VIDEO" con videoUrl
    And el usuario recibe MP4 en menos de 25s

  Scenario: Generar podcast guiado con Google TTS
    Given el usuario está autenticado
    And envía texto plano de meditación
    And ha seleccionado una pista de audio válida
    But no ha seleccionado imagen
    When solicita generar el contenido
    Then Google TTS genera voz real de meditación guiada desde el texto
    And FFmpeg mezcla voz TTS + música fondo con normalización podcast profesional
    And genera SRT sincronizado (para metadatos futuros)
    And la meditación se guarda tipo "AUDIO" con audioUrl
    And el usuario recibe MP3 en menos de 20s

  Scenario: Error Google TTS o FFmpeg timeout
    Given todos datos válidos
    But Google TTS o FFmpeg excede 30s
    When solicita generar
    Then rechaza con 408 "Timeout, intenta con texto más corto"
```
---

## US4 — Listar y reproducir meditaciones generadas

**Título**

Ver estado y reproducir meditaciones generadas

**User Story**

Como usuario autenticado, quiero ver el listado de mis meditaciones con su estado y reproducir las que ya están completadas, para poder hacer seguimiento y consumir el contenido generado.

**Descripción (negocio)**

El usuario puede consultar todas sus meditaciones, viendo para cada una su estado de procesamiento. Las meditaciones completadas pueden reproducirse directamente, mientras que las que aún están en proceso o han fallado sólo muestran su estado actual.

**Criterios de aceptación (BDD, lenguaje de negocio)**

`textFeature: Listado y reproducción de meditaciones

  Scenario: Listar las meditaciones del usuario con su estado
    Given el usuario está autenticado
    When solicita ver el listado de sus meditaciones
    Then el sistema muestra todas las meditaciones de ese usuario
    And para cada meditación se muestra su estado actual

  Scenario: Reproducir una meditación completada
    Given el usuario está autenticado
    And existe una meditación suya con estado "completada"
    When selecciona reproducir esa meditación
    Then el sistema reproduce el vídeo de esa meditación

  Scenario: No permitir reproducción de meditaciones no completadas
    Given el usuario está autenticado
    And existe una meditación suya que no está en estado "completada"
    When selecciona esa meditación en el listado
    Then el sistema muestra su estado actual
    And no ofrece la opción de reproducir el vídeo`

**Notas técnicas**

- El listado se obtiene mediante un endpoint que filtra por el usuario autenticado.
- Para meditaciones en estado DONE se devuelve una URL reproducible del almacenamiento en la nube; para el resto, esa URL no se expone.
- No se requiere paginación en esta primera versión.