@startuml 04-code-trips
' Generated by C4 Diagram Generator on 2026-01-15
' Agent: C4 Diagram Generator
' System: TravelSplit v1.0.0
' Stack: TypeScript, NestJS v11, TypeORM

title TravelSplit - Code Diagram (Trips Module)

skinparam class {
  BackgroundColor<<Controller>> #E1F5FE
  BackgroundColor<<Service>> #F3E5F5
  BackgroundColor<<Entity>> #E8F5E9
  BackgroundColor<<DTO>> #FFF3E0
  BackgroundColor<<Enum>> #FFECB3
  BackgroundColor<<Mapper>> #FCE4EC
  BackgroundColor<<Base>> #F5F5F5
}

package "Trips Module" {
  class TripsController <<Controller>> {
    - tripsService: TripsService
    + create(dto: CreateTripDto, req: AuthenticatedRequest): Promise<TripResponseDto>
    + findAll(query: TripListQueryDto, req: AuthenticatedRequest): Promise<TripListItemDto[]>
    + findOne(id: string, req: AuthenticatedRequest): Promise<TripDetailResponseDto>
    + joinByCode(dto: JoinTripDto, req: AuthenticatedRequest): Promise<TripResponseDto>
  }

  class TripsService <<Service>> {
    - tripRepository: Repository
    - tripParticipantRepository: Repository
    - userRepository: Repository
    - cacheManager: Cache
    - logger: Logger
    + create(dto: CreateTripDto, userId: string): Promise<TripResponseDto>
    + findAllByUser(userId: string, query: TripListQueryDto): Promise<TripListItemDto[]>
    + findOneById(tripId: string, userId: string, page: number, limit: number): Promise<TripDetailResult>
    + joinByCode(code: string, userId: string): Promise<Trip>
    - generateUniqueCode(): string
    - invalidateTripCache(tripId: string, userId: string): Promise<void>
  }

  class Trip <<Entity>> {
    + id: string
    + name: string
    + currency: string
    + status: TripStatus
    + code: string
    + participants: TripParticipant[]
    + createdAt: Date
    + updatedAt: Date
    + deletedAt: Date | null
  }

  class TripParticipant <<Entity>> {
    + id: string
    + tripId: string
    + userId: string
    + role: ParticipantRole
    + trip: Trip
    + user: User
    + createdAt: Date
    + updatedAt: Date
    + deletedAt: Date | null
  }

  enum TripStatus <<Enum>> {
    ACTIVE
    CLOSED
  }

  enum ParticipantRole <<Enum>> {
    CREATOR
    MEMBER
  }
}

package "DTOs" {
  class CreateTripDto <<DTO>> {
    + name: string
    + memberEmails?: string[]
  }

  class TripResponseDto <<DTO>> {
    + id: string
    + name: string
    + currency: string
    + status: TripStatus
    + code: string
    + createdAt: Date
  }

  class TripListItemDto <<DTO>> {
    + id: string
    + name: string
    + currency: string
    + status: TripStatus
    + code: string
    + userRole: ParticipantRole
    + participantCount: number
    + createdAt: Date
  }

  class TripDetailResponseDto <<DTO>> {
    + id: string
    + name: string
    + currency: string
    + status: TripStatus
    + code: string
    + participants: TripParticipantDto[]
    + paginationMeta: ParticipantsPaginationMeta
    + userRole: ParticipantRole
  }

  class JoinTripDto <<DTO>> {
    + code: string
  }
}

package "Common" {
  class BaseEntity <<Base>> {
    + id: string
    + createdAt: Date
    + updatedAt: Date
    + deletedAt: Date | null
  }

  class TripMapper <<Mapper>> {
    + {static} toResponseDto(trip: Trip): TripResponseDto
    + {static} toListItemDto(trip: Trip, role: ParticipantRole, count: number): TripListItemDto
    + {static} toDetailResponseDto(trip: Trip, meta: PaginationMeta, role: ParticipantRole): TripDetailResponseDto
  }
}

' Entity Relationships
Trip --|> BaseEntity : extends
TripParticipant --|> BaseEntity : extends
Trip "1" *-- "many" TripParticipant : has
TripParticipant --> Trip : belongs to
TripParticipant --> User : references

Trip --> TripStatus : uses
TripParticipant --> ParticipantRole : uses

' Controller Relationships
TripsController --> TripsService : uses
TripsController --> TripMapper : uses
TripsController --> CreateTripDto : receives
TripsController --> JoinTripDto : receives
TripsController --> TripResponseDto : returns
TripsController --> TripListItemDto : returns
TripsController --> TripDetailResponseDto : returns

' Service Relationships
TripsService --> Trip : manages
TripsService --> TripParticipant : manages
TripsService --> User : reads

note right of TripsController
  HTTP Layer
  - POST /trips (create)
  - GET /trips (list user's trips)
  - GET /trips/:id (detail)
  - POST /trips/join (join by code)
  - All routes protected by JwtAuthGuard
end note

note right of TripsService
  Business Logic Layer
  - Unique code generation with retry
  - Participant management (CREATOR/MEMBER)
  - Cache management for trip details
  - Pagination for participants
end note

note right of Trip
  Data Model
  - currency always 'COP'
  - code: 8 char alphanumeric unique
  - Soft delete support
end note

@enduml
