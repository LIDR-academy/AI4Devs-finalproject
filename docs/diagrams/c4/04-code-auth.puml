@startuml 04-code-auth
' Generated by C4 Diagram Generator on 2026-01-15
' Agent: C4 Diagram Generator
' System: TravelSplit v1.0.0
' Stack: TypeScript, NestJS v11, Passport JWT

title TravelSplit - Code Diagram (Auth Module)

skinparam class {
  BackgroundColor<<Controller>> #E1F5FE
  BackgroundColor<<Service>> #F3E5F5
  BackgroundColor<<DTO>> #FFF3E0
  BackgroundColor<<Strategy>> #E0F2F1
  BackgroundColor<<Mapper>> #FCE4EC
}

package "Auth Module" {
  class AuthController <<Controller>> {
    - authService: AuthService
    + login(loginDto: LoginDto): Promise<AuthResponseDto>
    + register(registerDto: RegisterDto): Promise<AuthResponseDto>
  }

  class AuthService <<Service>> {
    - usersService: UsersService
    - jwtService: JwtService
    + register(registerDto: RegisterDto): Promise<{user, accessToken}>
    + login(loginDto: LoginDto): Promise<{user, accessToken}>
    - generateToken(user: User): Promise<string>
  }

  class LoginDto <<DTO>> {
    + email: string
    + contrasena: string
  }

  class RegisterDto <<DTO>> {
    + nombre: string
    + email: string
    + contrasena: string
  }

  class AuthResponseDto <<DTO>> {
    + accessToken: string
    + user: UserResponseDto
  }
}

package "Common" {
  class JwtStrategy <<Strategy>> {
    + validate(payload: JwtPayload): Promise<User>
  }

  class JwtPayload <<Interface>> {
    + sub: string
    + email: string
  }

  class UserMapper <<Mapper>> {
    + {static} toResponseDto(user: User): UserResponseDto
  }
}

package "Users Module" {
  class UsersService <<Service>> {
    + create(dto: CreateUserDto): Promise<User>
    + findByEmail(email: string): Promise<User | null>
  }
}

package "External" {
  class JwtService <<NestJS/JWT>> {
    + signAsync(payload: object): Promise<string>
    + verifyAsync(token: string): Promise<JwtPayload>
  }

  class bcrypt <<Library>> {
    + {static} hash(password: string, rounds: number): Promise<string>
    + {static} compare(password: string, hash: string): Promise<boolean>
  }
}

' Relationships
AuthController --> AuthService : uses
AuthController --> UserMapper : uses
AuthController --> LoginDto : receives
AuthController --> RegisterDto : receives
AuthController --> AuthResponseDto : returns

AuthService --> UsersService : uses
AuthService --> JwtService : uses
AuthService --> bcrypt : uses for password validation
AuthService --> JwtPayload : creates

JwtStrategy --> JwtPayload : validates

note right of AuthController
  HTTP Layer
  - POST /auth/login
  - POST /auth/register
  - Returns JWT token on success
end note

note right of AuthService
  Business Logic Layer
  - User registration with auto-login
  - Password validation with bcrypt
  - JWT token generation
end note

note right of JwtStrategy
  Passport Strategy
  - Validates JWT tokens
  - Extracts user from payload
  - Used by JwtAuthGuard
end note

@enduml
