# T2 — Backend: Middleware API key y scopes company

| Campo | Valor |
|-------|--------|
| **ID** | T2 |
| **Título** | Backend: Middleware API key y scopes company |
| **Historia(s)** | [MH1](../historias-usuario/MH1.md) |
| **Área** | Backend |

## Descripción

Implementar el middleware que valide la API key en las peticiones (header `Authorization: Bearer {api_key}` o `X-API-Key`), resuelva la empresa asociada a esa key y deje el `company_id` (y opcionalmente el usuario) disponible para el resto de la aplicación. Incluye el registro del middleware en las rutas API y la exclusión de endpoints públicos. Los modelos con scope de empresa deben usar este contexto para filtrar datos.

## Criterios de aceptación

- **AC1**: Middleware (ej. `ApiAuth`) que lea el header Authorization o X-API-Key y valide la key contra la tabla `api_keys` (o equivalente).
- **AC2**: Si la key es válida, se asocia a una empresa; el `company_id` se inyecta en el request, en un servicio o en el contenedor para que los controladores y modelos lo usen.
- **AC3**: Si la key falta o es inválida, el middleware responde 401 Unauthorized con cuerpo JSON.
- **AC4**: Las rutas API protegidas usan este middleware; las rutas públicas (health, login, gas-stations/nearby) no lo usan.
- **AC5**: Los modelos con scope por empresa (CompanyScope o equivalente) aplican el filtro `company_id` automáticamente usando el contexto inyectado; super admin puede omitir el filtro si aplica.
- **AC6**: Documentación o comentarios en código sobre cómo registrar la API key (panel Filament o comando artisan).

## Notas técnicas

- `app/Http/Middleware/ApiAuth.php` (o nombre configurado). Registro en `bootstrap/app.php` o `Kernel`. Rutas en `routes/api.php` con `->middleware('api.auth')` en el grupo protegido.

---

[Índice de tickets](../tickets.md)
